<script>
async function loadProducts() {
  try {
    // Загружаем JSON со списком товаров
    const response = await fetch('webapp_data.json?nocache=' + new Date().getTime());
    const products = await response.json();

    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";

    products.forEach(item => {
      const row = document.createElement("tr");

      const nameCell = document.createElement("td");
      nameCell.textContent = item.name;

      const qtyCell = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.value = item.qty || "";
      qtyCell.appendChild(input);

      row.appendChild(nameCell);
      row.appendChild(qtyCell);
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error("Ошибка загрузки JSON:", error);
    document.getElementById("table-body").innerHTML =
      '<tr><td colspan="2" style="color:red;">Ошибка загрузки данных</td></tr>';
  }
}

// Загружаем список при открытии формы
loadProducts();

// Отправка данных
document.querySelector("form").addEventListener("submit", e => {
  e.preventDefault();

  const rows = document.querySelectorAll("#table-body tr");
  const result = [];

  rows.forEach(row => {
    const name = row.children[0].textContent.trim();
    const qty = row.children[1].children[0].value || "0";
    result.push({ name, qty: Number(qty) });
  });

  const json = JSON.stringify(result, null, 2);
  navigator.clipboard.writeText(json);
  alert("JSON скопирован в буфер обмена. Вставь его в чат бота и отправь.");
});
</script>
