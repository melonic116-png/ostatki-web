<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–û—Å—Ç–∞—Ç–∫–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body{font-family:system-ui,Arial; padding:14px; background:#f4f6f8; color:#111}
  h2{text-align:center}
  table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px;border-radius:8px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  input{width:90px;padding:6px;text-align:center}
  button{display:block;width:100%;padding:12px;margin-top:12px;border-radius:8px;border:none;font-size:16px;cursor:pointer;background:#28a745;color:#fff}
  .hint{font-size:13px;color:#444;margin-top:8px}
</style>
</head>
<body>
  <h2>üìã –û—Å—Ç–∞—Ç–∫–∏</h2>

  <div id="status" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <table id="tbl">
    <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th></tr></thead>
    <tbody></tbody>
  </table>

  <button id="saveBtn">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="hint">–ï—Å–ª–∏ WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, JSON –±—É–¥–µ—Ç –≤ –±—É—Ñ–µ—Ä–µ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ —á–∞—Ç –±–æ—Ç–∞.</div>

<script>
  const TG = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (TG && typeof TG.ready === 'function') { TG.ready(); TG.expand(); }

  // —Å–ø–∏—Å–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ webapp_data.json –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω)
  const fallback = [
    "–ë—É–ª–æ—á–∫–∞ –ë—É—Ä–≥–µ—Ä","–ê–π—Å–±–µ—Ä–≥ –∫–∞–ø—É—Å—Ç–∞","–ü–æ–º–∏–¥–æ—Ä—ã","–û–≥—É—Ä—Ü—ã",
    "–°–æ—É—Å –¶–µ–∑–∞—Ä—å","–°—ã—Ä –ß–µ–¥–¥–µ—Ä","–ö–æ—Ç–ª–µ—Ç–∞ –≥–æ–≤—è–∂—å—è","–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –§—Ä–∏"
  ];

  async function loadData() {
    const tbody = document.querySelector('#tbl tbody');
    let data = [];
    try {
      // –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π webapp_data.json (—Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–æ—Ç)
      const resp = await fetch(location.origin + '/webapp_data.json');
      if (resp.ok) {
        data = await resp.json();
      } else {
        // –ø—Ä–æ–±—É–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É (fallback –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π), –µ—Å–ª–∏ –µ—Å—Ç—å
        data = fallback.map(n => ({ name: n, qty: null }));
      }
    } catch (e) {
      data = fallback.map(n => ({ name: n, qty: null }));
    }

    // –∑–∞–ø–æ–ª–Ω–∏–º —Ç–∞–±–ª–∏—Ü—É ‚Äî –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º 0 –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    tbody.innerHTML = '';
    data.forEach(item => {
      const name = item.name || '';
      // –µ—Å–ª–∏ qty –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Ä–∞–≤–µ–Ω 0 –∏–ª–∏ null -> –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º
      const showVal = (item.qty !== undefined && item.qty !== null && item.qty !== 0) ? item.qty : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td><input type="number" min="0" value="${showVal}" data-name="${escapeHtml(name)}" placeholder=""></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('status').innerText = '–ì–æ—Ç–æ–≤–æ ‚Äî –≤–Ω–µ—Å–∏ —á–∏—Å–ª–∞ –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª';
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
    const out = rows.map(r => ({ name: r.querySelector('input').dataset.name, qty: Number(r.querySelector('input').value) || 0 }));
    const payload = JSON.stringify(out);
    if (TG && typeof TG.sendData === 'function') {
      TG.sendData(payload);
      TG.close();
    } else {
      // –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –∏ –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
      try {
        await navigator.clipboard.writeText(payload);
        alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä. –í—Å—Ç–∞–≤—å –µ–≥–æ –≤ —á–∞—Ç –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å.');
      } catch (e) {
        prompt('–°–∫–æ–ø–∏—Ä—É–π JSON –∏ –≤—Å—Ç–∞–≤—å –µ–≥–æ –≤ —á–∞—Ç –±–æ—Ç–∞:', payload);
      }
    }
  });

  loadData();
</script>
</body>
</html>
