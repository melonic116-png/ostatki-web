<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–û—Å—Ç–∞—Ç–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: system-ui, Arial;
      padding: 14px;
      background: #f4f6f8;
      color: #111;
    }
    h2 { text-align: center; margin-bottom: 10px; }
    #searchBox {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    input[type="number"] {
      width: 90px;
      padding: 6px;
      text-align: center;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: #28a745;
      color: #fff;
    }
    button:hover { background: #218838; }
    .hint {
      font-size: 13px;
      color: #444;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>üìã –û—Å—Ç–∞—Ç–∫–∏</h2>
  <input id="searchBox" type="text" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é..." />

  <div id="status" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <table id="tbl">
    <thead>
      <tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="saveBtn">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="hint">
    –ï—Å–ª–∏ WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, JSON –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ —á–∞—Ç –±–æ—Ç–∞.
  </div>

  <script>
    const TG = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (TG && typeof TG.ready === 'function') { TG.ready(); TG.expand(); }

    let allData = []; // –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
    let currentValues = {}; // —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤

    async function loadData() {
      const tbody = document.querySelector('#tbl tbody');
      try {
        const resp = await fetch('./webapp_data.json');
        allData = resp.ok ? await resp.json() : [];
      } catch {
        allData = [];
      }

      if (!allData.length) {
        allData = [
          { name: "–ë—É–ª–æ—á–∫–∞ –ë—É—Ä–≥–µ—Ä", qty: "" },
          { name: "–ê–π—Å–±–µ—Ä–≥ –∫–∞–ø—É—Å—Ç–∞", qty: "" },
          { name: "–ü–æ–º–∏–¥–æ—Ä—ã", qty: "" },
          { name: "–û–≥—É—Ä—Ü—ã", qty: "" }
        ];
      }

      // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º currentValues
      allData.forEach(item => {
        currentValues[item.name] = item.qty || "";
      });

      renderTable(allData);
      document.getElementById('status').innerText = '–ì–æ—Ç–æ–≤–æ ‚Äî –º–æ–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏.';
    }

    function renderTable(data) {
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const name = item.name || '';
        const showVal = currentValues[name] ?? "";
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(name)}</td>
          <td><input type="number" min="0" value="${showVal}" 
              data-name="${escapeHtml(name)}" placeholder=""></td>`;
        tbody.appendChild(tr);
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º currentValues –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
      document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', e => {
          const name = e.target.dataset.name;
          currentValues[name] = e.target.value;
        });
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    async function doSend(payload) {
      if (TG && typeof TG.sendData === 'function') {
        try {
          TG.sendData(payload);
          TG.close();
          return;
        } catch (e) { console.warn('–û—à–∏–±–∫–∞ Telegram sendData:', e); }
      }

      try {
        await navigator.clipboard.writeText(payload);
        alert("‚úÖ JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä.\n–¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å –µ–≥–æ (Ctrl+V) –≤ —á–∞—Ç –±–æ—Ç–∞.");
      } catch {
        prompt("–°–∫–æ–ø–∏—Ä—É–π JSON –≤—Ä—É—á–Ω—É—é –∏ –≤—Å—Ç–∞–≤—å –≤ Telegram:", payload);
      }
    }

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const out = allData.map(it => ({
        name: it.name,
        qty: Number(currentValues[it.name]) || 0
      }));
      const payload = JSON.stringify(out, null, 2);
      await doSend(payload);
    });

    // üîç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
    document.getElementById('searchBox').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allData.filter(it => it.name.toLowerCase().includes(term));
      renderTable(filtered);
    });

    loadData();
  </script>
</body>
</html>
