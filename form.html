<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–û—Å—Ç–∞—Ç–∫–∏</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body{font-family:system-ui,Arial; padding:14px; background:#f4f6f8; color:#111}
  h2{text-align:center}
  table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px;border-radius:8px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  input{width:90px;padding:6px;text-align:center}
  button{display:block;width:100%;padding:12px;margin-top:12px;border-radius:8px;border:none;font-size:16px;cursor:pointer;background:#28a745;color:#fff}
  .hint{font-size:13px;color:#444;margin-top:8px}
</style>
</head>
<body>
  <h2>üìã –û—Å—Ç–∞—Ç–∫–∏</h2>

  <div id="status" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <table id="tbl">
    <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th></tr></thead>
    <tbody></tbody>
  </table>

  <button id="saveBtn">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="hint">–ï—Å–ª–∏ WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî JSON –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.</div>

<script>
  const TG = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (TG && typeof TG.ready === 'function') { TG.ready(); TG.expand(); }

  // —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ JSON –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
  const fallback = [
    "–ë—É–ª–æ—á–∫–∞ –ë—É—Ä–≥–µ—Ä","–ê–π—Å–±–µ—Ä–≥ –∫–∞–ø—É—Å—Ç–∞","–ü–æ–º–∏–¥–æ—Ä—ã","–û–≥—É—Ä—Ü—ã",
    "–°–æ—É—Å –¶–µ–∑–∞—Ä—å","–°—ã—Ä –ß–µ–¥–¥–µ—Ä","–ö–æ—Ç–ª–µ—Ç–∞ –≥–æ–≤—è–∂—å—è","–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –§—Ä–∏"
  ];

  async function loadData() {
    const tbody = document.querySelector('#tbl tbody');
    let data = [];
    try {
      // –∞–Ω—Ç–∏–∫—ç—à: –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
      const antiCache = Math.floor(Math.random() * 100000);
      const resp = await fetch(`webapp_data.json?v=${antiCache}`);
      if (resp.ok) {
        data = await resp.json();
      } else {
        data = fallback.map(n => ({ name: n, qty: "" }));
      }
    } catch (e) {
      data = fallback.map(n => ({ name: n, qty: "" }));
    }

    tbody.innerHTML = '';
    data.forEach(item => {
      const name = item.name || '';
      const val = (item.qty !== undefined && item.qty !== null && item.qty !== 0) ? item.qty : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td><input type="number" min="0" value="${val}" data-name="${escapeHtml(name)}" placeholder=""></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('status').innerText = '–ì–æ—Ç–æ–≤–æ ‚Äî –º–æ–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏.';
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
    const out = rows.map(r => ({
      name: r.querySelector('input').dataset.name,
      qty: Number(r.querySelector('input').value) || 0
    }));
    const payload = JSON.stringify(out);
    if (TG && typeof TG.sendData === 'function') {
      TG.sendData(payload);
      TG.close();
    } else {
      try {
        await navigator.clipboard.writeText(payload);
        alert('‚úÖ JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –í—Å—Ç–∞–≤—å –µ–≥–æ –≤ —á–∞—Ç –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å.');
      } catch (e) {
        prompt('–°–∫–æ–ø–∏—Ä—É–π JSON –∏ –≤—Å—Ç–∞–≤—å –µ–≥–æ –≤ —á–∞—Ç –±–æ—Ç–∞:', payload);
      }
    }
  });

  loadData();
</script>
</body>
</html>
