<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Å—Ç–∞—Ç–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,Arial; padding:10px; background:#f7f7f7; margin:0}
    h2{text-align:center}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:6px; overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    input{width:90px; padding:6px; border-radius:4px; border:1px solid #ccc; text-align:center}
    .save{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); width:90%; background:#28a745; color:#fff; padding:12px; border-radius:8px; border:none; font-size:16px}
    .hint{margin-top:8px;color:#666;font-size:13px}
  </style>
</head>
<body>
  <h2>üìã –û—Å—Ç–∞—Ç–∫–∏</h2>
  <div id="tableWrap">
    <table id="tbl">
      <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="saveBtn" class="save">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="hint">–û—Ç–∫—Ä–æ–π —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ. –ï—Å–ª–∏ Telegram –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É ‚Äî —Å–∫–æ–ø–∏—Ä—É–π JSON –∏ –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –≤—Ä—É—á–Ω—É—é.</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

// –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ webapp_data.json (–µ—Å–ª–∏ —É —Ç–µ–±—è —Ä–∞–∑–º–µ—â—ë–Ω)
async function fetchData() {
  // –ü–æ–ø—Ä–æ–±—É–π raw.githubusercontent (–±—ã—Å—Ç—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–∏ GitHub repo)
  const candidates = [
    location.origin + '/webapp_data.json',
    'https://raw.githubusercontent.com/melonic116-png/ostatki-web/main/webapp_data.json'
  ];
  for (let url of candidates) {
    try {
      const r = await fetch(url + '?' + Date.now());
      if (r.ok) {
        const data = await r.json();
        return data;
      }
    } catch(e) {
      // ignore –∏ –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π
    }
  }
  // fallback: –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
  return [];
}

function render(items){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  items.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td><input type="number" id="q${idx}" value="${it.qty||0}" min="0"></td>`;
    tbody.appendChild(tr);
  });
}

async function init(){
  const items = await fetchData();
  if(!items || !items.length){
    // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ 3
    render([
      {name:'–ë—É–ª–æ—á–∫–∞ –ë—É—Ä–≥–µ—Ä', qty:0},
      {name:'–ê–π—Å–±–µ—Ä–≥ –∫–∞–ø—É—Å—Ç–∞', qty:0},
      {name:'–ü–æ–º–∏–¥–æ—Ä—ã', qty:0}
    ]);
    return;
  }
  render(items);
}

document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const rows = document.querySelectorAll('#tbl tbody tr');
  const out = [];
  rows.forEach((r, i)=>{
    const name = r.children[0].innerText.trim();
    const qty = Number(r.children[1].querySelector('input').value) || 0;
    out.push({name, qty});
  });

  // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram WebApp
  try {
    tg.sendData(JSON.stringify(out));
    tg.close();
  } catch (e) {
    // fallback: –ø–æ–∫–∞–∂–µ–º JSON –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    const s = JSON.stringify(out, null, 2);
    // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
    alert('WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–∫–æ–ø–∏—Ä—É–π JSON (OK), –∑–∞—Ç–µ–º –≤—Å—Ç–∞–≤—å –∏ –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –≤ —á–∞—Ç.\n\n' + s);
    // –ø—ã—Ç–∞–µ–º—Å—è —Ç–∞–∫–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
    try {
      await navigator.clipboard.writeText(s);
      alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –í—Å—Ç–∞–≤—å –≤ —á–∞—Ç –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å.');
    } catch(e){}
  }
});

init();
</script>
</body>
</html>
